# AI Debug & Build Playbook

### Purpose

A living log and template for hypothesis‑driven debugging, implementation, and testing when collaborating with an AI assistant on your web‑app work.

---

## How to use this document

1. **Copy the template below** into a fresh section each time you raise a new issue or feature request.
2. Fill in the *Observed symptom* (or *Desired feature*) field.
3. Ask the AI to populate *Hypotheses*, a detailed *Implementation plan*, and an *Automated test script*.
4. Run (or let the AI run) the test; paste outcomes in *Results & notes*.
5. Iterate by updating the same entry or creating a linked follow‑up entry.
6. Avoid commit and push changes to Github until the human test and validated the changes 

---

## Entry template

```markdown
### [YYYY‑MM‑DD] Issue / Feature: <concise title>

**Attempt number**
1

**Observed symptom / Desired behaviour**
<brief description or error snippet>

**Hypotheses (root‑cause or design assumptions)**
1.
2.
3.

**Implementation plan**
- [ ] Step 1
- [ ] Step 2
- [ ] Step 3

**Automated test script (AI‑generated by default)**
```bash
# e.g. pytest test_html_render.py
````

## **Results & notes**

*

**Lessons & next steps**

* What did we learn from this attempt?
* What will we change for the next attempt?

```bash
# e.g. pytest test_html_render.py
```

## **Results & notes**

*

```

---

## Log of issues & experiments

### [2025-05-08] Issue: Resume Content Alignment Inconsistencies

**Attempt number**
1

**Observed symptom / Desired behaviour**
Resume content shows inconsistent alignment in the HTML/PDF preview:
1. Role descriptions aligned with company names instead of with bullet points
2. Section header boxes not aligned with section content
3. Bullet points for achievements not consistently aligned with other content

**Hypotheses (root-cause or design assumptions)**
1. HTML structure issues: Role descriptions might be placed outside the proper containing element
2. CSS margin/padding inconsistencies: Different margin and padding values applied inconsistently
3. Duplicate CSS rules: Overlapping and conflicting rules in the CSS files
4. Container relationship issues: Parent-child relationships not properly structured for consistent alignment

**Implementation plan**
- [x] Analyze HTML generation in the `format_job_entry` function to check placement of role descriptions
- [x] Check section box styling and its relationship to content alignment in _resume.scss
- [x] Review all margin/padding settings for consistency and use of design tokens
- [x] Look for duplicate or conflicting CSS rules that might affect alignment
- [x] Implement fixes for each issue and test in both HTML/PDF and DOCX formats

**Automated test script**
```bash
# Regenerate tokens after changes
python tools/generate_tokens.py

# Start the development server
python app.py

# Access http://localhost:5000 in browser
# Test the HTML preview, PDF download, and DOCX download 
# Compare alignment across all formats
```

## **Results & notes**

* Issue 1 (Role descriptions): Fixed by moving the role description inside the `job-content` div in the `format_job_entry` function of `html_generator.py`
* Issue 2 (Section header alignment): Fixed by adding `margin-left: $content-left-margin` to the `.section-box` class
* Issue 3 (Bullet point alignment): Fixed by adding consistent left margin to job containers and removing duplicate styling rules

The application now displays proper alignment in both HTML/PDF and DOCX outputs:
- Section headers properly aligned with content
- Role descriptions properly indented with bullet points
- Consistent bullet point indentation

**Lessons & next steps**

* HTML/CSS alignment requires careful attention to container relationships
* Using consistent design tokens for margins and padding helps maintain visual consistency
* Duplicate CSS rules can cause hard-to-diagnose styling issues
* Different output formats (HTML vs DOCX) require different technical approaches but can achieve the same visual result

Next steps:
1. Consider implementing visual regression testing for alignment issues
2. Create a visual style guide for alignment patterns
3. Review any remaining inconsistencies in section spacing

### [2025-05-11] Issue: DOCX Section Header Box Alignment

**Attempt number**
4

**Observed symptom / Desired behaviour**
Section header boxes in the DOCX output are not properly aligned with the content text:
- Section header boxes appear to have a different left indent than company/position text
- Role descriptions and bullet points have their own alignment, creating a visually inconsistent document
- Despite multiple attempts to fix with a global indent token, misalignment persists
- Need all elements (section headers, company info, positions, role descriptions, bullets) to align consistently

**Hypotheses (root-cause or design assumptions)**
1. **DOCX Formatting Layer Conflicts**: Multiple layers of formatting (styles, direct paragraph formatting, XML manipulation) are competing and overriding each other
2. **Inconsistent Formatting Approaches**: Some elements use direct paragraph properties, others use XML manipulation, creating inconsistencies 
3. **DOCX Numbering System**: Bullet points use a separate numbering definition system with its own indentation rules, not inheriting from paragraph styles
4. **Measurement Unit Conversion**: Inconsistent conversion between cm, points, and twips causes slight misalignments
5. **Box Border Consideration**: The section header box border width might not be properly accounted for in alignment calculations

**Implementation plan**
- [ ] Create a debug mechanism to examine the true indentation values in the generated DOCX:
  - [ ] Create helper function to output debugging info for all paragraph indents
  - [ ] Generate a sample DOCX and extract its XML to analyze formatting
  
- [ ] Standardize on a single formatting approach across all elements:
  - [ ] Choose either style-based or direct formatting
  - [ ] Implement all indentation consistently through the chosen approach
  - [ ] Remove any competing formatting methods

- [ ] Focus on section header box implementation:
  - [ ] Ensure section header uses same formatting method as content paragraphs
  - [ ] Account for border width in left indent calculations
  - [ ] Use style-level formatting as primary approach

- [ ] Fix bullet point alignment:
  - [ ] Review and update numbering definition system
  - [ ] Adjust bullet point indentation to be consistent with other elements
  - [ ] Ensure hanging indent is properly applied

- [ ] Create verification tests:
  - [ ] Generate and examine multiple DOCX outputs with different content types
  - [ ] Verify consistent alignment in all cases

**Automated test script**
```bash
# Regenerate tokens after changes
python tools/generate_tokens.py

# Create and save debugging output for DOCX generation
python -c "
import os
from docx import Document
from docx.shared import Cm
from utils.docx_builder import build_docx
from io import BytesIO

# Sample test case
request_id = os.listdir('static/uploads/temp_session_data')[0].split('_')[0]
temp_dir = 'static/uploads/temp_session_data'

# Build DOCX
docx_bytes = build_docx(request_id, temp_dir)

# Save for manual inspection
with open('debug_output.docx', 'wb') as f:
    f.write(docx_bytes.getvalue())

print('Saved debug DOCX for manual inspection')
"

# Start the app to test changes
python app.py
```

## **Results & notes**

*

**Lessons & next steps**

* What we learn will determine our next approach
* If we need to coordinate with HTML/PDF output alignment, we should ensure our tokenization process converts CSS units to DOCX units consistently
* The ultimate goal is a single styling system that works across all output formats consistently

### [2025-05-20] Issue: DOCX Section Header Box Height and Spacing Issues

**Attempt number**
2

**Observed symptom / Desired behaviour**
Two issues were observed with the DOCX section header box styling:
1. Section header box height is enlarged/bloated compared to the desired compact appearance in PDF (shown in image 1)
2. There's excess whitespace between the end of section content and the start of the next section header box (shown in image 2, green circled area)

**Hypotheses (root-cause or design assumptions)**
1. **Box Height Issue**:
   - Default paragraph line spacing (1.15-1.2) is being applied to boxed headings, creating extra space
   - Border padding value (5pt) is too large, adding unwanted internal space
   - Missing explicit line height control in XML structure
   - Word's automatic spacing feature is adding additional space

2. **Extra Space Between Sections**:
   - Empty paragraphs with spacing are being added between sections in the docx_builder.py
   - Both the end of content and start of headers have spacing, creating double spacing
   - Word's automatic spacing behavior is adding additional gaps

**Implementation plan**
- [x] **Fix Box Height Issue**:
  - [x] Set explicit line spacing to 1.0 (single spacing) in BoxedHeading2 style
  - [x] Use XML to apply exact line height with `w:lineRule="exact"` 
  - [x] Set explicit space_before to 0 to prevent auto spacing
  - [x] Add XML attributes to disable automatic spacing with `w:beforeAutospacing="0"` and `w:afterAutospacing="0"`
  - [x] Reduce border padding from 5pt to 2pt for more compact appearance

- [x] **Fix Extra Space Between Sections**:
  - [x] Remove empty paragraphs that add spacing between sections in docx_builder.py
  - [x] Set explicit space_before to 0 on section headers to prevent space above
  - [x] Apply consistent spacing rules across all styling methods

**Automated test script**
```python
# Test our fix for section header spacing issues
python test_fix_spacing_issues.py

# Generate a sample DOCX with multiple sections to verify spacing
python -c "
from style_engine import StyleEngine, TokenAccessor
from docx import Document
from docx.shared import Pt
from utils.docx_builder import add_section_header

# Create a test document
doc = Document()
tokens = StyleEngine.load_tokens()

# Section 1
header1 = add_section_header(doc, 'PROFESSIONAL SUMMARY', {})
doc.add_paragraph('Summary text with reduced spacing above and compact box height.')

# Content paragraphs
para1 = doc.add_paragraph('Multiple paragraphs of text to show spacing between content.')
para1.paragraph_format.space_before = Pt(0)
para1.paragraph_format.space_after = Pt(6)

para2 = doc.add_paragraph('This should have normal paragraph spacing.')
para2.paragraph_format.space_before = Pt(0)
para2.paragraph_format.space_after = Pt(6)

# Section 2 - should be close to preceding content
header2 = add_section_header(doc, 'EXPERIENCE', {})
doc.add_paragraph('Experience section with reduced box height and proper spacing.')

# Save document
doc.save('test_spacing_fix.docx')
print('Created test_spacing_fix.docx for inspection')
"

# Test in actual app by restarting it
python app.py
```

## **Results & notes**

* **Fix 1: Box Height Issue**:
  * Setting `line_spacing = 1.0` and using `w:lineRule="exact"` successfully reduced the box height
  * Reducing border padding from 5pt to 2pt made the boxes more compact and visually appealing
  * Using direct XML manipulation for spacing properties provided more precise control than the python-docx API alone
  * Setting explicit `space_before = Pt(0)` ensured no extra space appeared above the heading

* **Fix 2: Extra Space Between Sections**:
  * Removing empty paragraphs from docx_builder.py eliminated unnecessary gaps between sections
  * Setting consistent spacing rules on content paragraphs created predictable spacing
  * Disabling Word's auto spacing with XML attributes prevented Word from adding its own spacing

The implementation was successful, with the generated DOCX now showing:
1. Compact section header boxes with proper internal spacing
2. No excess whitespace between the end of content and the next section header

**Lessons & next steps**

* **Word Spacing Insights**:
  * Word uses multiple spacing mechanisms that can conflict: paragraph spacing, line spacing, and automatic spacing
  * Direct XML manipulation provides more precise control than the python-docx API alone
  * Border padding contributes significantly to the visual appearance of boxed elements

* **Design Decisions**:
  * Spacing should be controlled through paragraph properties, not empty paragraphs
  * A consistent approach must be used across all styling methods (direct formatting, style-based, XML-based)
  * Line spacing and space before/after values should be explicitly set rather than relying on defaults

**Next steps**:
1. Apply similar spacing controls to job title/date elements (Task 3)
2. Create additional automated tests to verify spacing properties in generated documents
3. Add documentation for future developers on Word's spacing behavior and our approach

### [2025-05-21] Issue: Final Fix for DOCX Section Spacing Issues

**Attempt number**
3

**Observed symptom / Desired behaviour**
After our previous fixes, we still observed:
1. Section header box height was reduced, but still needed to be tighter around the text
2. The spacing between section content and the next section header remained too large

**Hypotheses (root-cause or design assumptions)**
1. **Box Height Issue**:
   - Border padding (2pt) still too large for desired tight appearance
   - Line height (240) providing too much vertical space
   
2. **Section Spacing Issue**:
   - The real issue was the space_after value (6pt) on content paragraphs
   - Even with space_before=0 on headers, the total space equals content space_after + header space_before
   - Space accumulates in Word, requiring zero space on the last paragraph before each header

**Implementation plan**
- [x] **Further Reduce Box Height**:
  - [x] Reduce border padding from 2pt to 1pt in design_tokens.json
  - [x] Reduce the exact line height from 240 to 220 in XML config
  
- [x] **Fix Section Spacing**:
  - [x] Create a post-processing function in docx_builder.py
  - [x] Find paragraphs right before section headers
  - [x] Set space_after=0 on those paragraphs using both API and XML
  - [x] Apply the fix right before saving the document

**Automated test script**
```python
# Test our final spacing fix implementation
python test_revised_spacing_fix.py

# Verify our changes in the actual app
python app.py
```

## **Results & notes**

* **Box Height Fix**:
  * Successfully reduced border padding to 1pt in design_tokens.json
  * Changed line height from 240 to 220 in style_engine.py
  * Box now appears properly compact around the section header text

* **Section Spacing Fix**:
  * Successfully implemented _fix_spacing_between_sections helper function
  * Function identifies paragraphs right before section headers
  * Sets space_after=0 using both API and direct XML manipulation
  * The spacing between content and next section header is now minimal

**Lessons & next steps**

* **Word Spacing Model**:
  * Word combines multiple spacing factors: paragraph spacing, line spacing, auto spacing
  * Space between elements = space_after of first + space_before of second
  * Simply controlling header spacing isn't enough; must control last content paragraph too
  * Post-processing is more effective than trying to adjust each paragraph during creation

* **Implementation Strategy**:
  * Direct XML control (w:lineRule="exact", w:beforeAutospacing="0") is essential
  * Post-processing approach allows consistent spacing without modifying every creation function
  * Combining API and XML approaches provides maximum control and compatibility

**Next steps**:
1. Apply similar techniques to job title boxes in Task 3
2. Create a more general spacing control mechanism
3. Add visual regression testing for spacing issues
