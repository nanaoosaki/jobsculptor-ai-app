# Feature Implementation Plan: Add Role Descriptions to Experience Section

**Goal:** Enhance the tailored resume by adding a concise role description below the job title in the Experience section. This description will be tailored if provided in the original resume or generated by the LLM if missing, based on the job title and bullet points.

**Branch:** `add_role_descriptions`

---

## Phase 1: Data Structure & Parsing Update

**Objective:** Modify the data structure to accommodate the role description and update the parsing logic to identify existing descriptions.

**Tasks:**

1.  **Modify JSON Schema:** Define the updated structure for entries in the `experience` list within the resume JSON. Each job dictionary should now include an optional `role_description: str | None` field.
    *   **File(s) Affected:** Documentation (if schema exists), potentially implied structure in parsers/handlers.
2.  **Update LLM Resume Parser:** Modify the prompt and potentially the post-processing logic in `llm_resume_parser.py` to *attempt* to identify text between the job title/company/date line and the bullet points as the `role_description`. Populate the new field if found; otherwise, set it to `null` or `""`.
    *   **File(s) Affected:** `llm_resume_parser.py`
3.  **Update Fallback Parser (if applicable):** If a non-LLM parser (`resume_processor.py`?) is used as a fallback, update its logic to attempt the same identification.
    *   **File(s) Affected:** `resume_processor.py` (or relevant parsing module)
4.  **Testing:** Test the updated parsing logic with resumes containing and lacking role descriptions to ensure the `role_description` field is populated correctly.

**Estimated Time:** 1-2 days

---

## Phase 2: LLM Tailoring Integration

**Objective:** Update the LLM tailoring process to handle the new `role_description` field, either tailoring existing content or generating new content.

**Tasks:**

1.  **Update Tailoring Prompt:** Modify the prompt sent to the tailoring LLM (`claude_integration.py` or equivalent).
    *   Instruct the LLM to check the `role_description` field for each job in the `experience` section.
    *   If `role_description` has content, tailor it along with the title and bullet points.
    *   If `role_description` is empty/null, generate a concise (1-2 sentences) description based on the `position` (title) and the *original* `achievements` (bullet points). Place the generated text in the `role_description` field of the output JSON.
    *   Specify output format requirements clearly.
    *   **File(s) Affected:** `claude_integration.py`, potentially `tailoring_handler.py` (for prompt construction).
2.  **Update Response Handling:** Ensure the code in `tailoring_handler.py` correctly extracts the (potentially new) `role_description` from the LLM's response and saves it to the tailored JSON file (e.g., `static/uploads/temp_session_data/{request_id}_experience_tailored.json`).
    *   **File(s) Affected:** `tailoring_handler.py`
3.  **Testing:** Test the tailoring process with various inputs (with/without existing descriptions) and verify the LLM output and the resulting tailored JSON.

**Estimated Time:** 2-3 days

---

## Phase 3: HTML Display Implementation

### Successful Implementation:

1. **HTML Generation:**
   - Updated `html_generator.py` to include `role_description` in the job entry formatting.
   - Ensured that `role_description` is displayed below the position and dates in the HTML preview.

2. **Styling:**
   - Added styling for `.role-description-text` in `_resume.scss` to ensure consistent display.
   - Compiled SCSS to CSS to reflect the new styles in both the HTML preview and PDF.

3. **Testing:**
   - Verified that the `role_description` appears correctly in the HTML preview and PDF download.
   - Confirmed that the display matches the sample resume format without additional symbols.

4. **Outcome:**
   - The implementation was successful, and the `role_description` is now correctly integrated into the resume display pipeline.

---

## Phase 4: PDF Generation Update

**Objective:** Ensure the role description renders correctly and consistently in the PDF output.

**Tasks:**

1.  **Update PDF Template:** Modify the Jinja template `templates/resume_pdf.html`. Add logic similar to Phase 3.1 to render the `role_description` within the experience loop, using the same HTML structure and class (`role-description-text`).
    *   **File(s) Affected:** `templates/resume_pdf.html`
2.  **Verify PDF Styling:** Since `pdf_exporter.py` uses WeasyPrint with `print.css`, the styles added in Phase 3.2 *should* apply. Generate PDFs and verify the rendering and styling of the `role_description`. Adjust styles in `print.scss` (and recompile) if necessary for PDF-specific tweaks.
    *   **File(s) Affected:** `static/scss/print.scss` (if needed), `static/css/print.css`
3.  **Testing:** Generate PDFs for various test cases and compare them against the HTML preview for consistency.

**Estimated Time:** 1 day

---

## Phase 5: End-to-End Testing & Refinement

**Objective:** Conduct thorough testing of the entire workflow and refine prompts or styling as needed.

**Tasks:**

1.  **Comprehensive Testing:** Test the full workflow with diverse resume inputs (DOCX, PDF, with/without descriptions, complex/simple job entries) and job descriptions.
2.  **Prompt Tuning:** Evaluate the quality of generated descriptions. Refine the LLM prompt in Phase 2 if necessary for better conciseness, relevance, or tone.
3.  **Style Adjustments:** Make final tweaks to SCSS based on visual review of HTML and PDF outputs.
4.  **Code Review & Cleanup:** Review all changes, add comments where necessary, and remove any debug code.
5.  **Documentation Update:** Update `README.md` or other relevant documentation (`TASK.md`?) to reflect the new feature.

**Estimated Time:** 1-2 days

---

**Total Estimated Time:** 6-9 days

---

## Learnings and Solution

### Key Learnings:

1. **Understanding Data Types:**
   - When dealing with data that can be of multiple types (e.g., strings, lists, dictionaries), ensure that all functions handling this data are aware of these types and can process them correctly.
   - Implement type-aware checks to prevent errors like `AttributeError` when methods assume a specific type.

2. **Modular Code Review:**
   - When fixing an issue, review all related functions and modules that interact with the data. Ensure that changes in one part of the codebase don't introduce errors elsewhere.
   - In this case, both `tailor_resume_with_llm` and the `tailor_resume_content` methods needed updates to handle lists correctly.

3. **Testing and Validation:**
   - After implementing a fix, thoroughly test the application with various inputs to ensure the issue is resolved and no new issues are introduced.
   - Logs are invaluable for tracing the flow of data and identifying where errors occur.

4. **Documentation:**
   - Keep documentation up-to-date with changes in the codebase. This includes updating any dependencies or interactions between modules.
   - Documenting the solution and learnings helps future developers understand the context and reasoning behind changes.

### Solution:

- Implemented type-aware checks in both `tailor_resume_with_llm` and `tailor_resume_content` methods to handle string, list, and dictionary types correctly.
- Ensured that all sections of the resume are processed correctly, regardless of their data type.
- Updated documentation to reflect these changes and provide guidance for future modifications.

---

## Implementation Issues & Fixes (Continued)

### Issue 2: Sections Skipped During Tailoring (Experience, Education, etc.)

**Symptoms:**
*   The "Tailored Resume Preview" in the UI is missing sections like Experience, Education, Skills, Projects.
*   The corresponding temporary JSON files in `static/uploads/temp_session_data/` (e.g., `_experience.json`) contain minimal content like `{"content": ""}` instead of the expected tailored data.
*   API response logs in `static/uploads/api_responses/` are only generated for the `summary` section.
*   Application logs show messages like "Skipping empty or missing section: experience" during the tailoring phase.
*   Application logs may also show a fallback to "traditional resume section extraction" even if LLM parsing should have worked.

**Cause:**
1.  The LLM parser successfully returns the `experience` section as a list of dictionaries.
2.  The `extract_resume_sections` function in `claude_integration.py` iterates through the LLM-parsed sections to clean bullet points using `clean_bullet_points`.
3.  `clean_bullet_points` expects a string input, but receives a *list* for the `experience` section, causing an internal `AttributeError`.
4.  This error is caught by a general exception handler in `extract_resume_sections`, which incorrectly triggers a fallback to the less reliable traditional parsing method.
5.  The traditional parser fails to extract the Experience, Education, Skills, and Projects sections correctly from the specific resume format.
6.  The `tailor_resume_with_llm` function receives these empty sections and skips the LLM tailoring step for them, resulting in empty output files and missing sections in the final preview.

**Fix Plan:**

1.  **Modify `extract_resume_sections` (in `claude_integration.py`):**
    *   Locate the loop where it processes sections returned by the LLM parser (`llm_sections`).
    *   **Before** calling `clean_bullet_points`, check the `section_name` and the `type` of the `content`.
    *   If `section_name == 'experience'` and `isinstance(content, list)`, **do not** call `clean_bullet_points`. Instead, directly assign the list `content` to `cleaned_sections['experience']`.
    *   For all *other* sections where `content` is a string (`isinstance(content, str)`), proceed with calling `clean_bullet_points` as before.
    *   Handle any other unexpected content types gracefully (e.g., log a warning and convert to string).
2.  **Testing:**
    *   Restart the application.
    *   Upload a resume and run the tailoring process.
    *   Check the application logs to confirm that LLM parsing is used and the fallback to traditional parsing *does not* occur.
    *   Verify that API response logs are now created for *all* relevant sections (experience, education, skills, etc.) in the `api_responses` folder.
    *   Inspect the temporary JSON files (e.g., `_experience.json`) in `temp_session_data` to ensure they contain the *structured, tailored* data returned by the LLM.
    *   (Later) Confirm the tailored preview UI (Phase 3/4) displays these sections correctly.

### Issue 3: AttributeError: 'list' object has no attribute 'strip' during Tailoring

**Symptoms:**
*   After applying the fix for "Issue 2", running the tailoring process with a resume successfully parsed by the LLM results in a 500 Internal Server Error.
*   The application logs show `AttributeError: 'list' object has no attribute 'strip'` originating from the `tailor_resume_with_llm` function in `claude_integration.py` (specifically around the line checking `resume_sections[section_name].strip()`).

**Cause:**
1.  The `extract_resume_sections` function now correctly returns the `experience` section as a `List[Dict]` when LLM parsing succeeds.
2.  The `tailor_resume_with_llm` function iterates through the extracted sections (`resume_sections`) to decide which ones to send for tailoring.
3.  The check `if section_name in resume_sections and resume_sections[section_name].strip():` assumes the content (`